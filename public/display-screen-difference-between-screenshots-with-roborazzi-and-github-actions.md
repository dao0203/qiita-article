---
title: roborazziã§å–å¾—ã—ãŸã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’PRã«ã¦è¡¨ç¤ºã™ã‚‹
tags:
  - Android
  - GitHub
  - GitHubActions
  - Roborazzi
private: false
updated_at: '2024-02-24T02:28:42+09:00'
id: afebaeb10af0219e29a0
organization_url_name: null
slide: false
ignorePublish: false
---
# ã¯ã˜ã‚ã«
ã“ã‚“ã«ã¡ã¯ã€ã“ã‚“ã°ã‚“ã¯ã€ä½è—¤ä½‘å“‰ã§ã™ã€‚
æœ¬æ—¥ã¯ã€Androidã‚¢ãƒ—ãƒªé–‹ç™ºã§ä½¿ç”¨ã•ã‚Œã‚‹Roborazziã‚’ç”¨ã„ã¦ã€ç”»é¢ã®å·®åˆ†ã‚’PRã®ã‚³ãƒ¡ãƒ³ãƒˆã«è¡¨ç¤ºã™ã‚‹ã‚’GitHubActionsã§å®Ÿç¾ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚
## æœ¬è¨˜äº‹ã®å‹•æ©Ÿ
å‰å›æŠ•ç¨¿ã—ãŸroborazziã§ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã®æ–¹ãªã®ã§ã™ãŒã€ç¾çŠ¶ã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã¨å·®åˆ†ãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆã®ã¿ã«ãªã£ã¦ãŠã‚Šã€å®Ÿç”¨æ€§ã«æ¬ ã‘ã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚’GitHub Actionsã‚’ä½¿ç”¨ã—ã¦ã€å®Ÿéš›ã«é–‹ç™ºã§ã‚‚å®Ÿç”¨ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã®ãŒæœ¬è¨˜äº‹ã®å‹•æ©Ÿã§ã™ã€‚

https://qiita.com/dao0203/items/f6f3633b8e8a0ce6c49d

## ä½¿ç”¨ã™ã‚‹æŠ€è¡“
æœ¬è¨˜äº‹ã§ä½¿ç”¨ã™ã‚‹GitHub Actionsã¨Roborazziã®ã¿ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

https://github.co.jp/features/actions

https://github.com/takahirom/roborazzi

## å‰å›ã®è¨˜äº‹ã®ã¾ã¨ã‚
å‰å›ã¾ã§, roborazziã‚’ä½¿ç”¨ã—ã¦VRTã‚’è¡Œã„ã€ç”Ÿæˆã•ã‚ŒãŸã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚„å·®åˆ†ãƒ¬ãƒãƒ¼ãƒˆã‚’è¡¨ç¤ºã™ã‚‹ã¨ã“ã‚ã¾ã§è¡Œã„ã¾ã—ãŸã€‚ä»Šå›ã¯ãã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ç”¨ã„ã¦ã€PRã«è¡¨ç¤ºã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚


https://github.com/dao0203/todo-sample-app

## ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æ¯”è¼ƒã—ã¦PRã«è¡¨ç¤ºã™ã‚‹ã¾ã§ã®æµã‚Œ
ä»Šå›ã¯ã€[takahirom](https://github.com/takahirom)ã•ã‚“ãŒä½œæˆã—ãŸ[ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ](https://github.com/takahirom/roborazzi-compare-on-github-comment-sample)workflowã‚’å‚è€ƒã«ã—ã¦ã€ä½œæˆã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

ä¸‹è¨˜ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒä»Šå›ã®å®Ÿè£…ã®æ§‹æˆå›³ã«ãªã‚Šã¾ã™ã€‚

![githubactionsæ§‹æˆå›³.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2989029/1e8fb531-cc89-02ef-a8e8-ae54399eb179.png)

### å¤‰æ›´å‰ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æˆæœç‰©ã¨ã—ã¦ä¿å­˜ã™ã‚‹
ã¾ãšã¯ã˜ã‚ã«ã€mainãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰å¤‰æ›´ã™ã‚‹å‰ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ä½œæˆã—ã€æˆæœç‰©ã¨ã—ã¦ä¿å­˜ã—ã¾ã™ã€‚

```yml:store-screenshot.yml
name: StoreScreenshot

on:
  push:
    branches:
      - main

jobs:
  store-screenshot-test:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    permissions:
      contents: read # for checkout
      actions: write # for upload-artifact

    steps:
      ## Androidé–‹ç™ºã®ç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¯çœç•¥
      ## ...

      - name: record screenshot
        run: |
          ./gradlew recordRoborazziDebug --stacktrace --rerun-tasks

      - uses: actions/upload-artifact@v4
        if: ${{ always() }}
        with:
          name: screenshots
          path: |
            actual_images/ # å¤‰æ›´å‰ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ä¿å­˜ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
          retention-days: 30
```

### StoreScreenshotãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã¨å¤‰æ›´å¾Œã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æ¯”è¼ƒã—ã€ç”Ÿæˆã•ã‚ŒãŸå·®åˆ†ã‚’æˆæœç‰©ã¨ã—ã¦ä¿å­˜ã™ã‚‹
æ¬¡ã«meinãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰å¤‰æ›´å‰ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’å–å¾—ã—ã€å¤‰æ›´å¾Œã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã¨æ¯”è¼ƒã—ã¦ã€å·®åˆ†ã‚’ç”Ÿæˆã—ã¾ã™ã€‚


```yml:compare-screenshot.yml
name: CompareScreenshot

on:
  pull_request:

jobs:
  compare-screenshot-test:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    permissions:
      contents: read
      actions: write

    steps:
      ## Androidé–‹ç™ºã®ç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¯çœç•¥
      ## ...

      ## mainãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰å¤‰æ›´å‰ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’å–å¾—
      - uses: actions/download-artifact@v2
        continue-on-error: true
        with:
          name: screenshots
          workflow: StoreScreenshot
          branch: main

      ## å¤‰æ›´å‰ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã¨æ¯”è¼ƒã—ã€å·®åˆ†ã‚’ç”Ÿæˆ
      - name: compare screenshot test
        id: compare-screenshot-test
        run: |
          ./gradlew compareRoborazziDebug --stacktrace

      ## å·®åˆ†ã‚’æˆæœç‰©ã¨ã—ã¦ä¿å­˜
      - uses: actions/upload-artifact@v4
        if: ${{ always() }}
        with:
          name: screenshots-diff
          path: |
            **/build/outputs/roborazzi/
          retention-days: 30

      ## PRç•ªå·ã‚’ä¿å­˜
      - name: Save PR number
        run: |
          mkdir -p ./pr
            echo "${{ github.event.number }}" > ./pr/NR

      ## PRç•ªå·ã‚’æˆæœç‰©ã¨ã—ã¦ä¿å­˜
      - name: upload PR number
        uses: actions/upload-artifact@v4
        with:
          name: pr
          path: pr/
```


### æˆæœç‰©ã‚’ä½¿ç”¨ã—ã¦ã€PRã«ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦è¡¨ç¤ºã™ã‚‹
æœ€å¾Œã«ã€ç”Ÿæˆã•ã‚ŒãŸå·®åˆ†ã‚’PRã«è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

```yml:compare-screenshot-comment.yml
name: Screenshot compare comment

on:
  ## CompareScreenshotãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå®Œäº†ã—ãŸã¨ã
  workflow_run:
    workflows:
      - CompareScreenshot
    types: [ completed ]

## ä¸¦åˆ—å‡¦ç†ã‚’è¡Œã†
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref }}-${{ github.event.workflow_run.id }}
  cancel-in-progress: true

jobs:
  comment-compare-screenshot:
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success'

    timeout-minutes: 2

    permissions:
      actions: read
      contents: write
      pull-requests: write

    runs-on: ubuntu-latest

    steps:
      ## PRç•ªå·ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      - uses: dawidd6/action-download-artifact@v2
        with:
          name: pr
          run_id: ${{ github.event.workflow_run.id }}

      # PRç•ªå·ã‚’å–å¾—
      - id: get-pull-request-number
        name: Get pull request number
        shell: bash
        run: |
          echo "pull_request_number=$(cat NR)" >> "$GITHUB_OUTPUT"

      ## mainãƒ–ãƒ©ãƒ³ãƒã«æˆ»ã‚‹
      - name: main checkout
        uses: actions/checkout@v4
        with:
          ref: main

      ## ã‚³ãƒŸãƒƒãƒˆå±¥æ­´ã‚’æŒãŸãªã„ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ
      - name: switch companion branch
        env:
          BRANCH_NAME: companion_${{ github.event.workflow_run.head_branch }}
        run: |
          git branch -D $BRANCH_NAME || true
          git checkout --orphan $BRANCH_NAME
          git rm -rf .

      ## CompareScreenshotãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§ç”Ÿæˆã•ã‚ŒãŸå·®åˆ†ã‚’å–å¾—
      - uses: dawidd6/action-download-artifact@v3
        with:
          name: screenshots-diff
          path: screenshots-diff
          run_id: ${{ github.event.workflow_run.id }}

      ## å·®åˆ†ã®ç”»åƒãŒå‘½åè¦å‰‡ã«å¾“ã£ã¦ã„ã‚‹ã‹ç¢ºèª
      - id: check-if-there-are-valid-files
        name: Check if there are valid files
        shell: bash
        run: |
          mapfile -t files_to_add < <(find . -type f -name "*_compare.png")
          
          exist_valid_files="false"
          for file in "${files_to_add[@]}"; do
            if [[ $file =~ ^[a-zA-Z0-9_./-]+$ ]]; then
              exist_valid_files="true"
              break
            fi
          done
          echo "exist_valid_files=$exist_valid_files" >> "$GITHUB_OUTPUT"

      ## å·®åˆ†ã®ç”»åƒã‚’companionãƒ–ãƒ©ãƒ³ãƒã«push
      - id: push-screenshot-diff
        shell: bash
        if: steps.check-if-there-are-valid-files.outputs.exist_valid_files == 'true'
        env:
          BRANCH_NAME: companion_${{ github.event.workflow_run.head_branch }}
        run: |
          files_to_add=$(find . -type f -name "*_compare.png")
          
          
          for file in $files_to_add; do
            if [[ $file =~ ^[a-zA-Z0-9_./-]+$ ]]; then
              git add $file
            fi
          done
          git config --global user.name ScreenshotBot
          git config --global user.email 41898282+github-actions[bot]@users.noreply.github.com
          git commit -m "Add screenshot diff"
          git push origin HEAD:$BRANCH_NAME -f

      ## å·®åˆ†ã®ç”»åƒã‚’PRã«è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆ
      - id: generate-diff-reports
        name: Generate diff reports
        if: steps.check-if-there-are-valid-files.outputs.exist_valid_files == 'true'
        env:
          BRANCH_NAME: companion_${{ github.event.workflow_run.head_branch }}
        shell: bash
        run: |
          files=$(find . -type f -name "*_compare.png" | grep "roborazzi/" | grep -E "^[a-zA-Z0-9_./-]+$")
          delimiter="$(openssl rand -hex 8)"
          {
            echo "reports<<${delimiter}"
          
            echo "Snapshot diff report"
            echo "| File name | Image |"
            echo "|-------|-------|"
          } >> "$GITHUB_OUTPUT"
          
          for file in $files; do
            fileName=$(basename "$file" | sed -r 's/(.{20})/\1<br>/g')
            echo "| [$fileName](https://github.com/${{ github.repository }}/blob/$BRANCH_NAME/$file) | ![](https://github.com/${{ github.repository }}/blob/$BRANCH_NAME/$file?raw=true) |" >> "$GITHUB_OUTPUT"
          done
          echo "${delimiter}" >> "$GITHUB_OUTPUT"

      ## ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—
      - name: Find Comment
        uses: peter-evans/find-comment@v2
        id: fc
        if: steps.generate-diff-reports.outputs.reports != ''
        with:
          issue-number: ${{ steps.get-pull-request-number.outputs.pull_request_number }}
          comment-author: "github-actions[bot]"
          body-includes: "Snapshot diff report"

      ## ã‚³ãƒ¡ãƒ³ãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆã€æ–°è¦ä½œæˆ
      - name: Add or update comment on PR
        uses: peter-evans/create-or-update-comment@v3
        if: steps.generate-diff-reports.outputs.reports != ''
        with:
          comment-id: ${{ steps.fc.outputs.comment-id }}
          issue-number: ${{ steps.get-pull-request-number.outputs.pull_request_number }}
          body: ${{ steps.generate-diff-reports.outputs.reports }}
          edit-mode: replace

      ## æœŸé™åˆ‡ã‚Œã«ãªã£ãŸcompanionãƒ–ãƒ©ãƒ³ãƒã‚’å‰Šé™¤
      - name: Clean up outdated companion branches
        run: |
          git branch -r --format="%(refname:lstrip=3)" | grep "companion_" | while read -r branch; do
            last_commit_date_timestamp=$(git log -1 --format="%ct" "origin/$branch")
            now_timestamp=$(date +%s)
          
            echo "branch: $branch now_timestamp: $now_timestamp last_commit_date_timestamp: $last_commit_date_timestamp"
            if [ $((now_timestamp - last_commit_date_timestamp)) -gt 2592000 ]; then
              echo "Deleting branch $branch"
              git push origin --delete $branch
            fi
          done
```

ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ãŸã®ã§ã€ç”»é¢ã«å°‘ã—ã ã‘å¤‰æ›´ã‚’åŠ ãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```kotlin:HomeScreen.kt
/*...*/
Spacer(modifier = Modifier.height(6.dp))
LazyColumn { /*...*/ }
/*...*/
```

ã“ã‚Œã‚ˆã†ã«å®Ÿè£…ã‚’ã™ã‚‹ã“ã¨ã§ã€ä»¥ä¸‹ã®å†™çœŸã®ã‚ˆã†ã«PRã«å·®åˆ†ã‚’è¡¨ç¤ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2024-02-23 21.42.41.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2989029/b6dd84e7-d71d-0c87-46af-a1130a68b55a.png)





## ã¾ã¨ã‚
ä»Šå›ã¯ã€Roborazziã¨GitHub Actionsã‚’ä½¿ç”¨ã—ã¦ç”»é¢ã®å·®åˆ†ã‚’PRã«è¡¨ç¤ºã™ã‚‹å®Ÿè£…ã‚’ã„ãŸã—ã¾ã—ãŸã€‚

ä»Šå›ã¯ã€GitHub Actionsã‚’ãƒ¡ã‚¤ãƒ³ã«è§¦ã‚Šã€åˆã‚ã¦ã®æŠ€è¡“ã°ã‹ã‚Šã§ã—ãŸã€‚
ç‰¹ã«artifactã®ç†è§£ã«è‹¦ã—ã¿ã€ã€Œå¤‰æ›´å‰ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã©ã†ã‚„ã‚‹ã‚“ã ãƒ»ãƒ»ãƒ»ã€ã€Œå¤‰æ›´å¾Œã®ç”»é¢ãŒpushã•ã‚ŒãŸã‚‰å¤‰æ›´å¾Œã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã¯ã©ã†ã™ã‚‹ã‚“ã ãƒ»ãƒ»ãƒ»ã€ã¿ãŸã„ã«ãªã£ã¦ã„ã¾ã—ãŸã€‚
ã—ã‹ã—ã€ä»Šå›ã®å®Ÿè£…ã‚’ãã£ã‹ã‘ã«ã€é–‹ç™ºç’°å¢ƒã‚’åŠ¹ç‡åŒ–ã™ã‚‹ã¨ã„ã†ç‚¹ã§æŠ€è¡“é ˜åŸŸã‚’åºƒã’ã‚‹ã“ã¨ã¯ã§ããŸã®ã¯è‰¯ã„çµŒé¨“ã«ãªã‚Šã¾ã—ãŸã€‚

ã¾ãŸã€ä»Šå›ã¯å†™çœŸã®ä¿å­˜æ–¹æ³•ã¨ã—ã¦ã€GitHubã®storageã¨copnaionãƒ–ãƒ©ãƒ³ãƒã‚’ä½¿ç”¨ã—ã¾ã—ãŸãŒã€[Nowinandroid](https://github.com/android/nowinandroid)ã®ã‚ˆã†ã«ã€ãƒªãƒã‚¸ãƒˆãƒªã«ç›´æ¥ä¿å­˜ã™ã‚‹æ–¹æ³•ã‚‚ã‚ã‚Šã€ãã‚Œãã‚Œã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«åˆã‚ã›ã¦é¸æŠã™ã‚‹ã“ã¨ãŒã§ããã†ã§ã™ã€‚

æœ€å¾Œã«ã¯ãªã‚Šã¾ã™ãŒã€æœ¬è¨˜äº‹ãŒèª°ã‹ã®åŠ›ã«ãªã‚Œã°å¹¸ã„ã§ã™ğŸ˜†
