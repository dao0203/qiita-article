---
title: reg-suitã¨roborazziã‚’ä½¿ç”¨ã—ã¦VRTã‚’è¡Œã„ã€å·®åˆ†ã‚’PRã«è¡¨ç¤ºã™ã‚‹
tags:
  - Android
  - GitHubActions
  - reg-suit
  - VRT
  - Roborazzi
private: false
updated_at: '2024-02-26T01:22:10+09:00'
id: 6709667949d97abdf39f
organization_url_name: null
slide: false
ignorePublish: false
---
# ã¯ã˜ã‚ã«
ã“ã‚“ã«ã¡ã¯ã€ã“ã‚“ã°ã‚“ã¯ã€ä½è—¤ä½‘å“‰ã§ã™ã€‚
æœ¬æ—¥ã¯ã€Androidã‚¢ãƒ—ãƒªé–‹ç™ºã§ä½¿ç”¨ã•ã‚Œã‚‹Roborazziã¨Reg-suitã‚’ç”¨ã„ã¦ã€VRTã‚’è¡Œã„ã€ãã®çµæœã‚’PRã«è¡¨ç¤ºã™ã‚‹æ–¹æ³•ã‚’GitHubActionsã§å®Ÿç¾ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

## æœ¬è¨˜äº‹ã®å‹•æ©Ÿ
ã“ã‚Œã¯ã€[å‰å›ã®è¨˜äº‹ã®ç¶šã](https://qiita.com/dao0203/items/afebaeb10af0219e29a0)ã«ãªã‚Šã¾ã™ã€‚
1ç•ªåˆã‚ã®VRTã®è¨˜äº‹ã§reg-suitã‚’ä½¿ç”¨ã—ã¦VRTã‚’è¡Œã„ã€å·®åˆ†ãƒ¬ãƒãƒ¼ãƒˆã‚’è¡¨ç¤ºã™ã‚‹ã¨ã“ã‚ã¾ã§ã‚„ã‚Šã¾ã—ãŸã€‚ãã—ã¦ã€å‰å›ã¯roborazziã®VRTã®çµæœã‚’PRã«è¡¨ç¤ºã™ã‚‹ã¨ã“ã‚ã¾ã§ã‚„ã‚Šã¾ã—ãŸã€‚
ä»Šå›ã¯ã€roborazziã¨reg-suitã‚’çµ„ã¿åˆã‚ã›ã¦ã€GitHub Actionsã‚’ä½¿ç”¨ã—ã¦ã€VRTã‚’è¡Œã„ã€ãã®çµæœã‚’PRã«è¡¨ç¤ºã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚
å‰å›ã®roborazziã§ã¯å·®åˆ†ã®å†™çœŸã‚„ã‚³ãƒ¡ãƒ³ãƒˆã‚’PRã«è¡¨ç¤ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸãŒã€reg-suitã®ã‚µã‚¤ãƒˆã«ã¯å‹•çš„ã«å·®åˆ†ã‚’è¡¨ç¤ºã™ã‚‹æ©Ÿèƒ½ãŒã‚ã‚Šã€ã‚µã‚¤ãƒˆã®æ–¹ãŒè¦‹ã‚„ã™ã„ã¨æ„Ÿã˜ãŸã®ã§ã€ãã‚Œã‚’PRã«è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

## ä½¿ç”¨ã™ã‚‹æŠ€è¡“
ä»Šå›ã¯ä»¥ä¸‹ã®æŠ€è¡“ã‚’ä½¿ç”¨ã—ã¦ã„ãã¾ã™ã€‚

reg-suit
VRTã‚’è¡Œã„ã€å·®åˆ†ãƒ¬ãƒãƒ¼ãƒˆã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«

https://reg-viz.github.io/reg-suit/

Roborazzi
ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æ’®å½±ã™ã‚‹ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

https://github.com/takahirom/roborazzi

GitHub Actions
CI/CDã‚’è¡Œã†ãŸã‚ã®ãƒ„ãƒ¼ãƒ«

https://github.co.jp/features/actions

GitHub Pages
GitHubã®é™çš„ãƒšãƒ¼ã‚¸ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã‚µãƒ¼ãƒ“ã‚¹

https://docs.github.com/ja/pages/getting-started-with-github-pages/about-github-pages


## å‰å›ã®è¨˜äº‹ã®ã¾ã¨ã‚
å‰å›ã®è¨˜äº‹ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªã“ã¨ã‚’è¡Œã„ã¾ã—ãŸã€‚

https://qiita.com/dao0203/items/afebaeb10af0219e29a0

![roborazziã®workflowæ§‹æˆå›³.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2989029/940f3f7e-b138-be0a-877d-36287a946021.png)

å‰å›ã¯GitHubã®Storageã‚’ä½¿ç”¨ã—ã¦ã€å¤‰æ›´å‰ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ä¿å­˜ã—ã€ãã‚Œã‚’æ¯”è¼ƒã—ã¦å·®åˆ†ã‚’è¡¨ç¤ºã™ã‚‹ã¨ã„ã†æµã‚Œã§ã—ãŸã€‚
ä»Šå›ã¯ã€reg-suitã«ã‚ˆã‚‹VRTãŒãƒ¡ã‚¤ãƒ³ãªã®ã§ã€roborazziã®å½¹å‰²ã§ã‚ã‚‹ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã®æ’®å½±ã®éƒ¨åˆ†ã¯å¤‰ã‚ã‚‰ãšã«ä½¿ç”¨ã—ã¦ã„ãã¾ã™ã€‚

## PRã«è¡¨ç¤ºã™ã‚‹ã¾ã§ã®æµã‚Œ
ä»Šå›ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªæµã‚Œã§å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚

å‰å›ã¨é•ã„ã€ä»Šå›ã¯ã‚µã‚¤ãƒˆã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã«ã€å®Ÿè£…ã‚³ã‚¹ãƒˆã‚‚ã‹ã‹ã‚‰ãšã€ç„¡æ–™ã§ä½¿ç”¨ã§ãã‚‹GitHub Pagesã‚’ä½¿ç”¨ã—ã¦ã„ãã¾ã™ã€‚

![roborazziã®workflowæ§‹æˆå›³ãã®2.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2989029/d542747f-0ff4-4baa-abe2-474555e30c0c.png)


### reg-suitã‚’ä½¿ç”¨ã—ã¦VRTã‚’è¡Œã†
ä»¥ä¸‹ã®ã‚ˆã†ã«`compare-screenshot.yml`ã®jobã‚’å¤‰æ›´ã—ã¦ã€VRTã‚’è¡Œã†ã‚ˆã†ã«ã—ã¾ã™ã€‚

ã¾ãšåˆã‚ã«ã€github pagesã«çµæœã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã«ã€actionsã‚’writeã«å¤‰æ›´ã—ã¾ã™ã€‚

```yml
permissions:
  contents: write
  actions: write
```

æ¬¡ã«ã€reg-suitãŒæ­£ã—ãå‹•ä½œã™ã‚‹ãŸã‚ã«ã€ç¾åœ¨ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã•ã‚Œã¦ã„ã‚‹Gitãƒ–ãƒ©ãƒ³ãƒã®çŠ¶æ…‹ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
reg-suitã®git-hash-pluginã¯ã€ãƒ™ãƒ¼ã‚¹ã‚³ãƒŸãƒƒãƒˆã®ãƒãƒƒã‚·ãƒ¥å€¤ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ã€ç¾åœ¨ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã•ã‚Œã¦ã„ã‚‹Gitãƒ–ãƒ©ãƒ³ãƒã®çŠ¶æ…‹ã‚’å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ã—ã‹ã—ã€GitHub Actionsã§å®Ÿè¡Œã•ã‚Œã‚‹ã¨ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§detached HEADçŠ¶æ…‹ã«ãªã£ã¦ã—ã¾ã†ãŸã‚ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€detached HEADçŠ¶æ…‹ã‚’è§£æ¶ˆã—ã¾ã™ã€‚
ã“ã‚Œã‚’ã—ãªã„ã¨ã€`reg-suit run`æ™‚ã«`Error: Fail to detect the current branch.
`ãŒç™ºç”Ÿã—ã¦ã—ã¾ã„ã€æ­£ã—ãVRTãŒè¡Œãˆã¾ã›ã‚“ã€‚

```yml
 ## #regs/head/ã‚’æ›¸ãã“ã¨ã§ã€ãƒ˜ãƒƒãƒ‰ãƒ–ãƒ©ãƒ³ãƒåã‚’å–å¾—ã§ãã‚‹
- name: workaround for detached HEAD
  run: |
    git checkout ${GITHUB_HEAD_REF#refs/heads/} || git checkout -b ${GITHUB_HEAD_REF#refs/heads/} && git pull origin ${GITHUB_HEAD_REF#refs/heads/}
```

æ¬¡ã«ã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’`.reg/expected`ã«ç§»å‹•ã—ã¾ã™ã€‚
reg-suitã¯ã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«ã€å¤‰æ›´å‰ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã¯`.reg/expected`ã«ä¿å­˜ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```yml
## å‰å›ã¨åŒã˜ãã€store-screenshot.ymlã§ä¿å­˜ã—ãŸã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
- uses: dawidd6/action-download-artifact@v2
  continue-on-error: true
  with:
    name: screenshots
    workflow: store-screenshot.yml
    branch: ${{ github.event.pull_request.base.ref || github.event.repository.default_branch }}

## å…ˆã»ã©ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’/.reg/expectedã«ç§»å‹•
- name: Move screenshots
  run: |
    mkdir -p .reg/expected
    mv actual_images/* .reg/expected ## actual_imagesã¯roborazziã§ä¿å­˜ã—ãŸã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå
```

æ¬¡ã«ã€å¤‰æ›´å¾Œã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’è¨˜éŒ²ã—ã¾ã™ã€‚
roborazziã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã®æ’®å½±ã®éƒ¨åˆ†ã¯å¤‰ã‚ã‚‰ãšã«ä½¿ç”¨ã—ã¦ã„ãã®ã§ã€ãã®ã¾ã¾è¨˜éŒ²ã—ã¾ã™ã€‚

```yml
- name: record screenshots
  id: record-screenshot-test
  run: |
    ./gradlew recordRoborazziDebug --stacktrace
```

æ¬¡ã«ã€reg-suitã®å®Ÿè¡Œã‚’è¡Œã„ã¾ã™ã€‚
ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã€VRTã‚’è¡Œã„ã€å·®åˆ†ãƒ¬ãƒãƒ¼ãƒˆã‚’è¡¨ç¤ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```yml
- name: run reg-suit
  id: compare-screenshot-test
  run: |
    yarn ci:reg-suit ## package.jsonã«è¨˜è¿°ã•ã‚Œã¦ã„ã‚‹ã‚³ãƒãƒ³ãƒ‰ reg-suit run ã‚’å®Ÿè¡Œ
```

æ¬¡ã«ã€çµæœã‚’github pagesã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚
ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã€github pagesã«çµæœã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```yml
- name: deploy test results to github pages
  uses: peaceiris/actions-gh-pages@v3
  with:
    github_token: ${{ secrets.GITHUB_TOKEN }}
    publish_dir: .reg
    destination_dir: ${{ github.head_ref }}
```

æœ€å¾Œã«ã€çµæœã‚’PRã«è¡¨ç¤ºã—ã¾ã™ã€‚

```yml
- name: find comment
  uses: peter-evans/find-comment@v3
  id: fc
  with:
    issue-number: ${{ github.event.pull_request.number }}
    comment-author: github-actions[bot]
    body-includes: '## Screenshot Test Results'

- name: upsert comment
  uses: peter-evans/create-or-update-comment@v4
  with:
    comment-id: ${{ steps.fc.outputs.comment-id }}
    issue-number: ${{ github.event.pull_request.number }}
    body: |
      ## Screenshot Test Results
      https://dao0203.github.io/todo-sample-app/${{ github.head_ref }}
    edit-mode: replace
```

ã“ã®ã‚ˆã†ã«å®Ÿè£…ã—ã€ä»¥ä¸‹ã®ã‚ˆã†ãªymlãƒ•ã‚¡ã‚¤ãƒ«ã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚

<details><summary>compare-screenshot.yml</summary><div>

```yml
name: CompareScreenshot

on:
  pull_request:

jobs:
  compare-screenshot-test:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    permissions:
      contents: write
      actions: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: adopt

      - name: Set up Gradle
        uses: gradle/gradle-build-action@v3
        with:
          gradle-version: wrapper

      - name: workaround for detached HEAD
        run: |
          git checkout ${GITHUB_HEAD_REF#refs/heads/} || git checkout -b ${GITHUB_HEAD_REF#refs/heads/} && git pull origin ${GITHUB_HEAD_REF#refs/heads/}

      - uses: dawidd6/action-download-artifact@v2
        continue-on-error: true
        with:
          name: screenshots
          workflow: store-screenshot.yml
          branch: ${{ github.event.pull_request.base.ref || github.event.repository.default_branch }}

      ## å…ˆã»ã©ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’/.reg/expectedã«ç§»å‹•
      - name: Move screenshots
        run: |
          mkdir -p .reg/expected
          mv actual_images/* .reg/expected

      ## å¤‰æ›´å¾Œã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’è¨˜éŒ²ã™ã‚‹
      - name: record screenshots
        id: record-screenshot-test
        run: |
          ./gradlew recordRoborazziDebug --stacktrace

      ## reg-suitã‚’å®Ÿè¡Œã—ã¦ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã®å·®åˆ†ã‚’ç¢ºèª
      - name: run reg-suit
        id: compare-screenshot-test
        run: |
          yarn ci:reg-suit

      - name: deploy test results to github pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .reg
          destination_dir: ${{ github.head_ref }}

      - name: find comment
        uses: peter-evans/find-comment@v3
        id: fc
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: github-actions[bot]
          body-includes: '## Screenshot Test Results'

      - name: upsert comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.fc.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## Screenshot Test Results
            https://dao0203.github.io/todo-sample-app/${{ github.head_ref }}
          edit-mode: replace
```
</div></details>

ã“ã‚Œã§ã€VRTã‚’è¡Œã„ã€ãã®çµæœã‚’PRã«è¡¨ç¤ºã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

![ScreenshotTestResult.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2989029/3c32215b-e3ee-98bd-8243-6e3aa2b845fc.png)


ã—ã‹ã—ã€ã“ã®ã¾ã¾ã ã¨ã€ã‚µã‚¤ãƒˆã‚’é–‹ã„ãŸæ™‚ã«ã€`404 Not Found`ãŒè¡¨ç¤ºã•ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚
ãã®ãŸã‚ã€GitHubPagesã§ã‚µã‚¤ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã«ã€`Settings -> Pages`ã«ç§»å‹•ã—ã€ä»¥ä¸‹ã®ã‚ˆã†ãªè¨­å®šã‚’è¡Œã„ã¾ã™ã€‚

![GitHubPagesConfig.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2989029/9c008534-821d-b0f6-f093-056dc32d4ca8.png)

ã“ã‚Œã«ã‚ˆã£ã¦ã€GitHubPagesã§ã‚µã‚¤ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2024-02-26 0.26.09.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2989029/0f788493-0799-358d-cc98-effef1f3541a.png)

## ã¾ã¨ã‚
ä»Šå›ã¯ã€reg-suitã¨roborazziã¨GitHubActionsã‚’ç”¨ã„ã¦ã€VRTã‚’è¡Œã„ã€ãã®çµæœã‚’GitHubPagesã«è¡¨ç¤ºã—ã€PRã«è¡¨ç¤ºã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚
GitHubPagesã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ã‚µã‚¤ãƒˆã®è¡¨ç¤ºãŒç°¡å˜ã«ã§ãã‚‹ãŸã‚ã€ãã“ã¾ã§å®Ÿè£…ã‚³ã‚¹ãƒˆã¨å¤‰æ›´ã‚³ã‚¹ãƒˆãŒã‹ã‹ã‚‰ãšã€ç„¡æ–™ã§ä½¿ç”¨ã§ãã‚‹ãŸã‚ã€ã¨ã¦ã‚‚ä¾¿åˆ©ã ã¨æ„Ÿã˜ã¾ã—ãŸã€‚
ã¾ãŸã€é–‹ç™ºã‚’é€šã˜ã¦ã€reg-suitã®é«˜æ©Ÿèƒ½ãªãƒ„ãƒ¼ãƒ«ã‚’æ´»ã‹ã—ãŸã¾ã¾ã€Roborazziã®é«˜é€Ÿãªã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã®æ’®å½±ã‚’æ´»ã‹ã™ã“ã¨ãŒã§ãã‚‹ãŸã‚ã€ç§»è¡Œä½œæ¥­ã‚‚ã‚¹ãƒ ãƒ¼ã‚ºã«è¡Œãˆã‚‹ã¨æ„Ÿã˜ã¾ã—ãŸã€‚

ä»Šå›ã®è¨˜äº‹ãŒã€VRTã‚’è¡Œã†éš›ã®å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ğŸ˜†
